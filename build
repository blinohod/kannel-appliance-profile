#!/bin/bash
#===========================================================================#
#                     Скрипт сборки профиля                                 #
#===========================================================================#
# (C) Denis Smirnov                                                May 2011 #
#===========================================================================#
OUTDIR=~/out/profiles/netstyle

# имя профиля (просто имя текущего каталога)
# здесь используется только для имени лога
pname=$(basename $(realpath .))

# имя временного каталога (у меня /mnt/auto/tmp -- это tmpfs монтирующийся
# через autofs, для того чтобы если я что-то собрал а потом занимаюсь чем-то
# еще -- он бы спокойно отмонтировался а не ел впустую память
tmpdir=~/tmp/$pname

# куда кладем логи
logdir=`realpath ..`

# на всякий случай :)
export NPROC; NPROC=1

# копирую во временный каталог этот профиль
make -C "$tmpdir" distclean
rsync -avP --delete-after  ./ "$tmpdir/"

pushd $tmpdir

# а тут просто выполняю сборку :)
make 2>&1 | tee $logdir/$pname.`date +%s`.log

# результат кладу в каталог, где у меня лежат все профили после сборки
# правильно, конечно, для этого перетащить профиль на autoconf и указывать OUTDIR
# там
mkdir -p $OUTDIR
mv -f .work/.out/*.xz $OUTDIR/

